function format(time) {
  return time < 10 ? "0" + time : time;
}

function transform(timeStamp, statement) {
  if (timeStamp) {
    var year = getDate(timeStamp).getFullYear();
    var month = format(getDate(timeStamp).getMonth() + 1);
    var day = format(getDate(timeStamp).getDate());
    var hours = format(getDate(timeStamp).getHours());
    var minutes = format(getDate(timeStamp).getMinutes());
    var seconds = format(getDate(timeStamp).getSeconds());
    return statement
      .replace("YYYY", year)
      .replace("MM", month)
      .replace("DD", day)
      .replace("hh", hours)
      .replace("mm", minutes)
      .replace("ss", seconds);
  }
}

function week(timeStamp) {
  if (timeStamp) {
    var todayDateString = getDate().toLocaleDateString();

    var tomorrowDate = getDate();
    tomorrowDate.setDate(tomorrowDate.getDate() + 1);
    var tomorrowDateString = tomorrowDate.toLocaleDateString();

    var thirdDate = getDate();
    thirdDate.setDate(thirdDate.getDate() + 2);
    var thirdDateString = thirdDate.toLocaleDateString();

    var curDateString = getDate(timeStamp).toLocaleDateString();

    if (curDateString === todayDateString) {
      return "今天";
    }
    if (curDateString === tomorrowDateString) {
      return "明天";
    }
    if (curDateString === thirdDateString) {
      return "后天";
    }
    return ["周一", "周二", "周三", "周四", "周五", "周六", "周日"][
      getDate(timeStamp).getDay() - 1
    ];
  }
}

function countdown(timeStamp, statement) {
  var days = Math.floor(timeStamp / (24 * 60 * 60));
  var hours = format(Math.floor((timeStamp % (24 * 60 * 60)) / (60 * 60)));
  var minutes = format(Math.floor((timeStamp % (60 * 60)) / 60));
  var seconds = format(Math.floor(timeStamp % 60));
  if (statement.indexOf("d") !== -1) {
    if (days) {
      return statement
        .replace("d", days)
        .replace("hh", hours)
        .replace("mm", minutes)
        .replace("ss", seconds);
    } else {
      return statement
        .slice(2)
        .replace("hh", hours)
        .replace("mm", minutes)
        .replace("ss", seconds);
    }
  } else {
    return statement
      .replace("hh", hours)
      .replace("mm", minutes)
      .replace("ss", seconds);
  }
}

function timeDiff(timeStamp) {
    var date = getDate(timeStamp);
    var now = getDate();

    var year = date.getFullYear();
    var month = date.getMonth() + 1;
    var day = date.getDate();
    var hour = date.getHours();
    var minute = date.getMinutes();

    var nowYear = now.getFullYear();
    var nowMonth = now.getMonth() + 1;
    var nowDay = now.getDate();

    var timeStr = format(hour) + ":" + format(minute);
    var dateStr = format(month) + "-" + format(day);
    var fullDateStr =
      year + "-" + format(month) + "-" + format(day);

    // 今天
    if (year === nowYear && month === nowMonth && day === nowDay) {
      return timeStr;
    }

    // 昨天
    var yesterday = getDate(now.getTime() - 24 * 60 * 60 * 1000);
    if (
      year === yesterday.getFullYear() &&
      month === yesterday.getMonth() + 1 &&
      day === yesterday.getDate()
    ) {
      return "昨天 " + timeStr;
    }

    // 前天
    var beforeYesterday = getDate(now.getTime() - 2 * 24 * 60 * 60 * 1000);
    if (
      year === beforeYesterday.getFullYear() &&
      month === beforeYesterday.getMonth() + 1 &&
      day === beforeYesterday.getDate()
    ) {
      return "前天 " + timeStr;
    }

    // 今年
    if (year === nowYear) {
      return dateStr + " " + timeStr;
    }

    // 跨年
    return fullDateStr + " " + timeStr;
  }


function calculateDuration(startTimeStamp, statement, endTimeStamp = 0) {
  if (startTimeStamp) {
    var diffValue;
    if (endTimeStamp != 0) {
      diffValue = endTimeStamp - startTimeStamp;
    } else {
      var now = getDate().getTime();
      diffValue = (now - startTimeStamp * 1000) / 1000;
    }
    return countdown(diffValue, statement);
  }
}

function formatReplyTime(minutes) {
  if (minutes <= 1) {
    return "1分钟";
  }

  if (minutes < 60) {
    var rounded = Math.round(minutes);
    return rounded + "分钟";
  }

  var hours = Math.floor(minutes / 60);
  var remainMins = Math.round(minutes % 60);

  if (hours < 24) {
    if (remainMins > 0) {
      return hours + "小时" + remainMins + "分钟";
    } else {
      return hours + "小时";
    }
  }

  var days = Math.floor(hours / 24);
  var remainHours = hours % 24;

  if (remainHours > 0) {
    return days + "天" + remainHours + "小时";
  } else {
    return days + "天";
  }
}


module.exports = {
  format: format,
  transform: transform,
  week: week,
  countdown: countdown,
  timeDiff: timeDiff,
  calculateDuration: calculateDuration,
  formatReplyTime: formatReplyTime
};
